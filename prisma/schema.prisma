
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  ORG_ADMIN
  SUPER_ADMIN
}

enum SiteStatus {
  ONLINE
  OFFLINE
  DEGRADED
  MAINTENANCE
}

enum IncidentStatus {
  INVESTIGATING
  IDENTIFIED
  MONITORING
  RESOLVED
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum SiteType {
  WEB
  API
  PING
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

enum Region {
  US_EAST        // North America - East (Virginia)
  US_WEST        // North America - West (California)
  EU_WEST        // Europe - West (Ireland)
  EU_CENTRAL     // Europe - Central (Frankfurt)
  ASIA_EAST      // Asia - East (Tokyo)
  ASIA_SOUTHEAST // Asia - Southeast (Singapore)
  AUSTRALIA      // Australia (Sydney)
  SOUTH_AMERICA  // South America (SÃ£o Paulo)
}

// Models
model AppSettings {
  id                  String   @id @default("app_settings") // Single row
  notifyOnManualCheck Boolean  @default(false) // Send email on manual checks (Application-wide)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Alert Settings (Organization-level)
  alertThreshold           Int     @default(2)     // Consecutive failures before incident
  alertCooldownMinutes     Int     @default(15)    // Minutes between repeat alerts
  maintenanceMode          Boolean @default(false) // Pause all alerts

  // Relationships
  users         User[]
  sites         Site[]
  sslChecks     SSLCheck[]
  subscription  Subscription?
  invitations   Invitation[]
  apiKeys       ApiKey[]
  webhooks      Webhook[]
  statusPage    StatusPage?
  aiInsights    AiInsight[]

  @@index([createdAt])
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String   // Hashed with bcrypt
  name          String
  role          UserRole @default(USER)
  avatar        String?
  emailVerified Boolean  @default(false)
  verificationToken String?
  verificationTokenExpires DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  // Notification Preferences - Event Types
  notifyOnIncident      Boolean @default(true)  // Receive incident alerts
  notifyOnResolution    Boolean @default(true)  // Receive resolution alerts
  notifyOnDegradation   Boolean @default(true)  // Receive degradation alerts
  notifyOnlyAdmins      Boolean @default(false) // Only notify if user is admin
  
  // Notification Preferences - Channels
  notifyViaEmail        Boolean @default(true)  // Send notifications via email
  notifyViaSlack        Boolean @default(false) // Send notifications via Slack
  notifyViaSms          Boolean @default(false) // Send notifications via SMS
  notifyViaWebhook      Boolean @default(false) // Send notifications via Webhook
  slackWebhookUrl       String? // Slack webhook URL
  smsPhoneNumber        String? // Phone number for SMS notifications
  customWebhookUrl      String? // Custom webhook URL for notifications
  
  // Foreign Keys
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relationships
  sites         Site[]
  incidents     Incident[]
  notifications Notification[]
  sessions      Session[]
  apiKeys       ApiKey[]
  webhooks      Webhook[]
  siteSubscriptions SiteSubscription[]
  passwordResets PasswordReset[]

  @@index([email])
  @@index([organizationId])
  @@index([role])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Site {
  id              String     @id @default(cuid())
  name            String
  url             String
  status          SiteStatus @default(ONLINE)
  uptime          Float      @default(100.0) // Percentage
  checkInterval   Int        @default(300) // Seconds (5 minutes default)
  averageLatency  Int        @default(0) // Milliseconds
  lastCheckedAt   DateTime?
  region          String?
  enabled         Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // SSL Certificate Monitoring (Current State)
  sslMonitoringEnabled  Boolean   @default(true)
  sslExpiryDate        DateTime?  // Current certificate expiry (cached from last check)
  sslIssuer            String?    // Current issuer (cached)
  sslValidFrom         DateTime?  // Current valid from (cached)
  sslDaysRemaining     Int?       // Current days remaining (cached)
  sslLastChecked       DateTime?  // Last check timestamp
  sslCertificateValid  Boolean   @default(true) // Current validity status
  sslAlertThreshold    Int       @default(30) // Days before expiry to alert

  // Security Headers Monitoring (Current State)
  securityScore         Int?      // Latest security score (0-100)
  lastSecurityCheck     DateTime? // Last security check timestamp

  // API Endpoint Monitoring
  siteType           SiteType   @default(WEB)
  httpMethod         HttpMethod @default(GET)
  requestHeaders     Json?      // Custom headers {"Authorization": "Bearer xxx"}
  requestBody        Json?      // Request payload for POST/PUT/PATCH
  expectedStatus     Int[]      @default([200]) // Expected status codes
  responseValidation Json?      // JSON schema or validation rules
  authType           String?    // NONE, BEARER, API_KEY, BASIC
  authValue          String?    // Encrypted auth value

  // Foreign Keys
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User         @relation(fields: [createdById], references: [id])

  // Relationships
  incidents      Incident[]
  checks         SiteCheck[]
  sslChecks      SSLCheck[]  // Historical SSL checks
  securityChecks SecurityCheck[] // Historical security checks
  apiChecks      ApiCheck[] // Historical API checks
  regionChecks   RegionCheck[] // Historical multi-region checks
  dnsChecks      DnsCheck[] // Historical DNS checks
  performanceChecks PerformanceCheck[] // Historical performance checks
  notifications  Notification[]
  subscribers    SiteSubscription[]
  aiInsights     AiInsight[]

  @@index([organizationId])
  @@index([status])
  @@index([createdById])
}

model SiteCheck {
  id             String   @id @default(cuid())
  siteId         String
  status         SiteStatus
  responseTime   Int      // Milliseconds
  statusCode     Int?
  errorMessage   String?
  checkedAt      DateTime @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([checkedAt])
}

model SSLCheck {
  id                String    @id @default(cuid())
  siteId            String
  organizationId    String
  valid             Boolean   @default(false)
  issuer            String?
  subject           String?
  validFrom         DateTime?
  validTo           DateTime?
  daysRemaining     Int?
  serialNumber      String?
  fingerprint       String?
  algorithm         String?
  authorized        Boolean?
  authorizationError String?
  errorMessage      String?
  checkedAt         DateTime  @default(now())

  site         Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([organizationId])
  @@index([checkedAt])
  @@index([validTo])
}

model Incident {
  id        String           @id @default(cuid())
  siteId    String
  status    IncidentStatus   @default(INVESTIGATING)
  severity  IncidentSeverity @default(MEDIUM)
  startTime DateTime         @default(now())
  endTime   DateTime?
  duration  Int?             // Milliseconds
  aiSummary String?          @db.Text
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Foreign Keys
  site          Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  resolvedById  String?
  resolvedBy    User?  @relation(fields: [resolvedById], references: [id])

  @@index([siteId])
  @@index([status])
  @@index([severity])
  @@index([startTime])
}

model Subscription {
  id                String             @id @default(cuid())
  plan              SubscriptionPlan   @default(FREE)
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean            @default(false)
  stripeCustomerId  String?            @unique
  stripeSubscriptionId String?         @unique
  amount            Int                @default(0) // Amount in cents
  currency          String             @default("USD")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Foreign Key - One subscription per organization
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([plan])
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      UserRole @default(USER)
  token     String   @unique
  expiresAt DateTime
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Foreign Key
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([organizationId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // email, sms, slack, webhook
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  sentAt    DateTime @default(now())

  // Foreign Keys
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  siteId String?
  site   Site?  @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([sentAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // create, update, delete, login, logout
  entity    String   // user, site, organization, etc.
  entityId  String
  userId    String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([userId])
  @@index([createdAt])
}

model ApiKey {
  id             String   @id @default(cuid())
  name           String
  key            String   @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User     @relation(fields: [createdById], references: [id])
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([key])
  @@index([organizationId])
  @@index([createdById])
  @@index([isActive])
}

model Webhook {
  id             String   @id @default(cuid())
  name           String
  url            String
  events         String[] // Array of event types: incident_created, incident_resolved, site_down, site_up
  isActive       Boolean  @default(true)
  secret         String?  // Optional webhook secret for signature verification
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User     @relation(fields: [createdById], references: [id])
  lastTriggeredAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([createdById])
  @@index([isActive])
}

model StatusPage {
  id             String   @id @default(cuid())
  slug           String   @unique // Custom URL slug for the status page
  title          String
  description    String?
  logoUrl        String?
  isPublic       Boolean  @default(true)
  customDomain   String?  // Optional custom domain
  showUptime     Boolean  @default(true)
  showIncidents  Boolean  @default(true)
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([slug])
  @@index([isPublic])
}

model SiteSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, siteId])
  @@index([userId])
  @@index([siteId])
}

model Plan {
  id                String   @id @default(cuid())
  name              String   @unique
  displayName       String
  description       String?
  price             Int      // Price in cents
  stripePriceId     String?
  isActive          Boolean  @default(true)
  isPopular         Boolean  @default(false)
  sortOrder         Int      @default(0)
  
  // Limits
  maxSites          Int      @default(-1) // -1 = unlimited
  maxTeamMembers    Int      @default(-1) // -1 = unlimited
  minCheckInterval  Int      @default(300) // Seconds
  maxAICredits      Int      @default(0)
  allowedChannels   String[] @default(["email"]) // Notification channels: email, slack, sms, webhook
  
  // Features (JSON array)
  features          Json     @default("[]")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}


model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model AiInsight {
  id              Int       @id @default(autoincrement())
  orgId           String
  siteId          String?
  title           String
  category        String?   // e.g., "Performance", "Alert"
  summary         String
  confidenceScore Float
  recommendations String?
  generatedAt     DateTime  @default(now())

  organization    Organization @relation(fields: [orgId], references: [id])
  site            Site?         @relation(fields: [siteId], references: [id])
}

model SecurityCheck {
  id          String   @id @default(cuid())
  siteId      String
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Security Headers
  hasHSTS             Boolean  @default(false)
  hstsMaxAge          Int?
  hstsIncludesSubdomains Boolean @default(false)
  hasCSP              Boolean  @default(false)
  cspPolicy           String?  @db.Text
  hasXFrameOptions    Boolean  @default(false)
  xFrameOptions       String?
  hasXContentType     Boolean  @default(false)
  hasXXSSProtection   Boolean  @default(false)
  hasReferrerPolicy   Boolean  @default(false)
  referrerPolicy      String?
  hasPermissionsPolicy Boolean @default(false)

  // Security Score
  securityScore       Int      @default(0) // 0-100
  grade               String?  // A+, A, B, C, D, F
  issues              Json?    // Array of security issues found
  recommendations     Json?    // Array of recommendations

  checkedAt           DateTime @default(now())

  @@index([siteId])
  @@index([checkedAt])
  @@index([securityScore])
}

model ApiCheck {
  id              String   @id @default(cuid())
  siteId          String
  site            Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  requestMethod   HttpMethod
  requestHeaders  Json?
  requestBody     Json?
  responseTime    Int      // ms
  statusCode      Int
  responseBody    Json?    // Store sample response (truncated if large)
  responseHeaders Json?
  validationPassed Boolean  @default(true)
  validationErrors Json?   // Array of validation errors
  errorMessage    String?

  checkedAt       DateTime @default(now())

  @@index([siteId])
  @@index([checkedAt])
  @@index([statusCode])
  @@index([validationPassed])
}

model RegionCheck {
  id              String     @id @default(cuid())
  siteId          String
  site            Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  region          Region     // Geographic region where check was performed
  status          SiteStatus // ONLINE, OFFLINE, DEGRADED
  responseTime    Int        // Milliseconds
  statusCode      Int?       // HTTP status code
  errorMessage    String?    // Error details if check failed
  resolvedIp      String?    // Resolved IP address
  dnsLookupTime   Int?       // DNS resolution time in ms
  connectTime     Int?       // TCP connection time in ms
  tlsHandshakeTime Int?      // TLS handshake time in ms (for HTTPS)

  checkedAt       DateTime   @default(now())

  @@index([siteId])
  @@index([region])
  @@index([checkedAt])
  @@index([status])
}

model DnsCheck {
  id              String   @id @default(cuid())
  siteId          String
  site            Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // DNS Resolution
  hostname        String   // Domain being checked
  resolutionTime  Int      // DNS lookup time in ms

  // A Records (IPv4)
  aRecords        Json?    // Array of IPv4 addresses

  // AAAA Records (IPv6)
  aaaaRecords     Json?    // Array of IPv6 addresses

  // CNAME Records
  cnameRecords    Json?    // Array of CNAME targets

  // MX Records (Mail servers)
  mxRecords       Json?    // Array of MX records with priority

  // NS Records (Nameservers)
  nsRecords       Json?    // Array of nameserver hostnames

  // TXT Records
  txtRecords      Json?    // Array of TXT record values

  // SOA Record (Start of Authority)
  soaRecord       Json?    // SOA record details

  // Nameserver Info
  nameservers     Json?    // Array of authoritative nameservers

  // Change Detection
  recordsHash     String?  // Hash of all records for change detection
  changesDetected Boolean  @default(false)
  previousHash    String?  // Previous hash for comparison

  // Status
  success         Boolean  @default(true)
  errorMessage    String?

  checkedAt       DateTime @default(now())

  @@index([siteId])
  @@index([hostname])
  @@index([checkedAt])
  @@index([changesDetected])
}

/**
 * Performance Monitoring
 *
 * Tracks detailed performance metrics including:
 * - Time to First Byte (TTFB)
 * - Page load times
 * - Resource loading metrics
 * - Core Web Vitals
 */
model PerformanceCheck {
  id              String   @id @default(cuid())
  siteId          String
  site            Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Overall Timing
  totalTime       Int      // Total request time in ms

  // Detailed Timing Breakdown
  dnsTime         Int?     // DNS lookup time in ms
  tcpTime         Int?     // TCP connection time in ms
  tlsTime         Int?     // TLS handshake time in ms
  ttfb            Int?     // Time to First Byte in ms
  downloadTime    Int?     // Content download time in ms

  // Response Metrics
  responseSize    Int?     // Response size in bytes
  transferSpeed   Float?   // Transfer speed in KB/s
  compression     Boolean  @default(false) // Whether response was compressed

  // HTTP Metrics
  statusCode      Int?
  redirectCount   Int      @default(0)
  redirectTime    Int?     // Time spent in redirects in ms

  // Core Web Vitals Simulation
  estimatedFCP    Int?     // Estimated First Contentful Paint in ms
  estimatedLCP    Int?     // Estimated Largest Contentful Paint in ms

  // Resource Analysis
  resourceCount   Int?     // Number of resources detected (from HTML parsing)
  resourceSizes   Json?    // Breakdown of resource sizes by type

  // Performance Score
  performanceScore Int?    // Overall performance score (0-100)
  grade           String?  // Performance grade (A, B, C, D, F)

  // Performance Issues
  issues          Json?    // Array of detected performance issues
  recommendations Json?    // Array of performance recommendations

  // Status
  success         Boolean  @default(true)
  errorMessage    String?

  checkedAt       DateTime @default(now())

  @@index([siteId])
  @@index([checkedAt])
  @@index([performanceScore])
  @@index([grade])
}